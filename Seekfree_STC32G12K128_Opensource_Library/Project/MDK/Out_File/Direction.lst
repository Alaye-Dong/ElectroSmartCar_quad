C251 COMPILER V5.60.0,  Direction                                                          26/06/23  11:07:02  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE Direction
OBJECT MODULE PLACED IN .\Out_File\Direction.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE Direction.c LARGE INTR2 ROM(HUGE) WARNINGLEVEL(3) BROWSE INCDIR(..\..\
                    -Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\CODE;..\USER\inc;..\USER\s
                    -rc) DEBUG PRINT(.\Out_File\Direction.lst) TABS(2) OBJECT(.\Out_File\Direction.obj) 

stmt  level    source

    1          #include "headfile.h"
    2          #include "direction.h"
    3          #include "math.h"
    4          
    5          extern int BEEP1;
    6          int sanchayou = 1;
    7          int zhidaoflag = 0;
    8          //Ö±µÀÁ½ºá50 Á½Ð±35 ÖÐ¼ä70
    9          
   10          /**********È«¾Ö±äÁ¿¶¨Òå********/
   11          int sancha_yuzhi = 0;
   12          int t = 0;
   13          
   14          
   15          float g_rolControl_P = 20.59;           //ÍäµÀ¿ØÖÆP
   16          float g_rolControl_D = 18.0;           //ÍäµÀ¿ØÖÆD
   17          float all, al, mid, arr, ar;
   18          float g_fDirectionError[5];      //·½ÏòÆ«²î£¨g_fDirectionError[0]ÎªÒ»¶ÔË®Æ½µç¸ÐµÄ²î±ÈºÍÆ«²î£©
   19          float g_fDirectionError_dot[3];  //·½ÏòÆ«²îÎ¢·Ö£¨g_fDirectionError_dot[0]ÎªÒ»¶ÔË®Æ½µç¸ÐµÄ²î±ÈºÍÆ«²îÎ¢·Ö£©
   20          float g_fDirectionControlOut;//·½Ïò¿ØÖÆÊä³ö
   21          int16 a_r = 0;
   22          int16 g_ValueOfAD[9] = {0};       //»ñÈ¡µÄµç¸ÐÖµ
   23          int16 g_ValueOfADFilter[5] = {0};
   24          
   25          int16 g_ValueOfADError;//Ö±µÀÆ«²î±êÖ¾
   26          uint16 ui_ValueOfADError;
   27          
   28          extern uint8 sw1_status;
   29          extern uint8 sw2_status;
   30          
   31          //¿ª¹Ø×´Ì¬±äÁ¿
   32          extern uint8 key1_status ;
   33          extern uint8 key2_status ;
   34          extern uint8 key3_status ;
   35          extern uint8 key4_status ;
   36          
   37          //ÉÏÒ»´Î¿ª¹Ø×´Ì¬±äÁ¿
   38          extern uint8 key1_last_status;
   39          extern uint8 key2_last_status;
   40          extern uint8 key3_last_status;
   41          extern uint8 key4_last_status;
   42          
   43          //¿ª¹Ø±êÖ¾Î»
   44          extern uint8 key1_flag;
   45          extern uint8 key2_flag;
   46          extern uint8 key3_flag;
   47          extern uint8 key4_flag;
   48          
   49          int Hall = 0;
   50          
   51          int last_PWMServo;
   52          
   53          float ad_min[9];
   54          float ad_max[9];
   55          
   56          float g_fSpeedErrorTemp[5];
   57          float g_n_Left_pulse;
C251 COMPILER V5.60.0,  Direction                                                          26/06/23  11:07:02  PAGE 2   

   58          float g_n_Right_pulse;
   59          float g_f_Left_RealSpeed;
   60          float g_f_Right_RealSpeed;
   61          float g_n_Leftpulse;
   62          float g_n_Righpulse;
   63          float Ratio_Encoder_Left;
   64          float Ratio_Encoder_Righ;
   65          float g_f_SpeedFilter;
   66          float g_f_RealSpeed;
   67          float g_f_SpeedError;
   68          float g_f_ExpectSpeed;
   69          
   70          float g_fSpeedControlOut;
   71          float fSpeedErrorInteg;
   72          float g_speedControl_I;
   73          float g_speedControl_P;
   74          
   75          
   76          /******************************************************************/
   77          
   78          void Read_ADC(void)
   79          {
   80   1          int16  i, j, k, temp;
   81   1          int16  ad_valu[9][5], ad_valu1[9], ad_sum[9];
   82   1          int16  ValueOfADOld[9], ValueOfADNew[9];
   83   1      
   84   1      //*******************************µç¸ÐÖµÂË²¨´¦Àí*******************************//
   85   1          for(i = 0; i < 5; i++)
   86   1          {
   87   2             ad_valu[0][i] = adc_once(ADC_P11, ADC_12BIT);   //zui you
   88   2              ad_valu[1][i] = adc_once(ADC_P05, ADC_12BIT);   //zhong jian
   89   2              ad_valu[2][i] = adc_once(ADC_P00, ADC_12BIT);    //ºá
   90   2              ad_valu[3][i] = adc_once(ADC_P13, ADC_12BIT);   //ºá
   91   2              ad_valu[4][i] = adc_once(ADC_P06, ADC_12BIT);   //zui zuo
   92   2              ad_valu[5][i] = adc_once(ADC_P01, ADC_12BIT);// 05     /
   93   2      //        ad_valu[0][i] = adc_once(ADC_P00, ADC_12BIT);   //zui you
   94   2      //        ad_valu[1][i] = adc_once(ADC_P01, ADC_12BIT);   //zhong jian
   95   2      //        ad_valu[2][i] = adc_once(ADC_P13, ADC_12BIT);    //you    xie
   96   2      //        ad_valu[3][i] = adc_once(ADC_P06, ADC_12BIT);   //zui zuo
   97   2      //        ad_valu[4][i] = adc_once(ADC_P11, ADC_12BIT);   //zui zuo
   98   2      //        ad_valu[5][i] = adc_once(ADC_P05, ADC_12BIT);// 05     //zuo   xie
   99   2      //         ad_valu[5][i]=adc_once(ADC_P13,ADC_12BIT);      //zuo   shu
  100   2      //         ad_valu[6][i]=adc_once(ADC_P14,ADC_12BIT);      //zuo   heng
  101   2      //         ad_valu[7][i]=adc_once(ADC_P15,ADC_12BIT);      //µÚ¶þÅÅºá
  102   2      //         ad_valu[8][i]=adc_once(ADC_P02,ADC_12BIT);       //
  103   2          }
  104   1      
  105   1      
  106   1          /*=========================Ã°ÅÝÅÅÐòÉýÐò==========================*///ÉáÆú×î´óÖµºÍ×îÐ¡Öµ
  107   1          for(i = 0; i < 9; i++)
  108   1          {
  109   2              for(j = 0; j < 5; j++)
  110   2              {
  111   3                  for(k = 0; k < 5 - j; k++)
  112   3                  {
  113   4                      if(ad_valu[i][k] > ad_valu[i][k + 1])      //Ç°ÃæµÄ±ÈºóÃæµÄ´ó  Ôò½øÐÐ½»»»
  114   4                      {
  115   5                          temp = ad_valu[i][k + 1];
  116   5                          ad_valu[i][k + 1] = ad_valu[i][k];
  117   5                          ad_valu[i][k] = temp;
  118   5                      }
  119   4                  }
  120   3              }
  121   2          }
  122   1      
  123   1          /*===========================ÖÐÖµÂË²¨=================================*/
C251 COMPILER V5.60.0,  Direction                                                          26/06/23  11:07:02  PAGE 3   

  124   1          for(i = 0; i < 9; i++) //ÇóÖÐ¼äÈýÏîµÄºÍ
  125   1          {
  126   2              ad_sum[i] = ad_valu[i][1] + ad_valu[i][2] + ad_valu[i][3];
  127   2              ad_valu1[i] = ad_sum[i] / 3;
  128   2          }
  129   1      
  130   1      
  131   1          for(i = 0; i < 9; i++)      //½«ÊýÖµÖÐ¸öÎ»Êý³ýµô
  132   1          {
  133   2              g_ValueOfAD[i] = (int16)(ad_valu1[i] / 10 * 10);
  134   2      
  135   2              //²É¼¯ÌÝ¶ÈÆ½»¬£¬Ã¿´Î²É¼¯×î´ó±ä»¯40
  136   2              ValueOfADOld[i] = g_ValueOfADFilter[i];
  137   2              ValueOfADNew[i] = g_ValueOfAD[i];
  138   2      
  139   2              if(ValueOfADNew[i] >= ValueOfADOld[i])
  140   2                  g_ValueOfADFilter[i] = ((ValueOfADNew[i] - ValueOfADOld[i]) > 50 ? (ValueOfADOld[i] + 50) : V
             -alueOfADNew[i]);
  141   2              else
  142   2                  g_ValueOfADFilter[i] = ((ValueOfADNew[i] - ValueOfADOld[i]) < -60 ? (ValueOfADOld[i] - 60) : 
             -ValueOfADNew[i]);
  143   2          }
  144   1      
  145   1      }
  146          
  147          
  148          unsigned int data diangan[9];
  149          short leftP = 0, leftV = 0, rightV = 0, rightP = 0, leftS = 0, rightS = 0, middle = 0, second_leftp = 0, 
             -second_rightp = 0;
  150          void InductorNormal(void)
  151          {
  152   1            Read_ADC();
  153   1          diangan[0]=g_ValueOfAD[0];      
  154   1          diangan[1]=g_ValueOfAD[1];      
  155   1          diangan[2]=g_ValueOfAD[2];    
  156   1          diangan[3]=g_ValueOfAD[3];
  157   1          diangan[4]=g_ValueOfAD[4];
  158   1          diangan[5]=g_ValueOfAD[5];  
  159   1      //    diangan[6]=g_ValueOfAD[6];  
  160   1      //    diangan[7]=g_ValueOfAD[7];
  161   1      //    diangan[8]=g_ValueOfAD[8];  
  162   1        
  163   1          leftP =  (float)(diangan[0] - 10.0) / (1800.0 - 100.0) * 100.0;   // µç¸Ð¹éÒ»»¯
  164   1          rightP =  (float)(diangan[1] - 10.0) / (1800.0 - 100.0) * 100.0;    // µç¸Ð¹éÒ»»¯
  165   1          leftV = (float)(diangan[2] - 10.0) / (1800.0 - 100.0) * 100.0;    // µç¸Ð¹éÒ»»¯
  166   1          rightV = (float)(diangan[3] - 10.0) / (1800.0 - 100.0) * 100.0;   // µç¸Ð¹éÒ»»¯ 
  167   1          leftS = (float)(diangan[4] - 10.0) / (1800.0 - 100.0) * 100.0;
  168   1          rightS = (float)(diangan[5] - 10.0) / (1800.0 - 100.0) * 100.0;
  169   1      //    middle = (float)(diangan[6] - 100.0) / (2850.0 - 100.0) * 100.0;
  170   1      //    second_leftp = (float)(diangan[7] - 100.0) / (1350.0 - 100.0) * 100.0;
  171   1      //    second_rightp = (float)(diangan[8] - 100.0) / (1150.0 - 100.0) * 100.0;
  172   1          
  173   1          (g_ValueOfAD[0]) = (leftP < 0) ? 0 : leftP;           //¹éÒ»»¯ºóÏÞÖÆÊä³ö·ù¶È
  174   1          (g_ValueOfAD[0]) = (leftP > 100) ? 100 : leftP;       //¹éÒ»»¯ºóÏÞÖÆÊä³ö·ù¶È
  175   1          (g_ValueOfAD[2]) = (rightV < 0) ? 0 : rightV;         //¹éÒ»»¯ºóÏÞÖÆÊä³ö·ù¶È
  176   1          (g_ValueOfAD[2]) = (rightV > 100) ? 100 : rightV;     //¹éÒ»»¯ºóÏÞÖÆÊä³ö·ù¶È
  177   1          (g_ValueOfAD[3]) = (leftV < 0) ? 0 : leftV;           //¹éÒ»»¯ºóÏÞÖÆÊä³ö·ù¶È
  178   1          (g_ValueOfAD[3]) = (leftV > 100) ? 100 : leftV;       //¹éÒ»»¯ºóÏÞÖÆÊä³ö·ù¶È
  179   1          (g_ValueOfAD[1]) = (rightP < 0) ? 0 : rightP;         //¹éÒ»»¯ºóÏÞÖÆÊä³ö·ù¶È
  180   1          (g_ValueOfAD[1]) = (rightP > 100) ? 100 : rightP;     //¹éÒ»»¯ºóÏÞÖÆÊä³ö·ù¶È    
  181   1          (g_ValueOfAD[4]) = (leftS < 0) ? 0 : leftS;
  182   1          (g_ValueOfAD[4]) = (leftS > 100) ? 100 : leftS;
  183   1          (g_ValueOfAD[5]) = (rightS < 0) ? 0 : rightS;
  184   1          (g_ValueOfAD[5]) = (rightS > 100) ? 100 : rightS;
  185   1          (g_ValueOfAD[6]) = (middle < 0) ? 0 : middle;
  186   1          (g_ValueOfAD[6]) = (middle > 100) ? 100 : middle;
C251 COMPILER V5.60.0,  Direction                                                          26/06/23  11:07:02  PAGE 4   

  187   1          (g_ValueOfAD[7]) = (second_leftp < 0) ? 0 : second_leftp;
  188   1          (g_ValueOfAD[7]) = (second_leftp > 100) ? 100 : second_leftp;
  189   1          (g_ValueOfAD[8]) = (second_rightp < 0) ? 0 : second_rightp;
  190   1          (g_ValueOfAD[8]) = (second_rightp > 100) ? 100 : second_rightp;
  191   1      }
  192          
  193          
  194          /************************************************************************
  195           * file *               ·½Ïò¿ØÖÆ
  196           *    Ò»°ãÇé¿öÏÂ£ºÓÃÁ½Ë®Æ½µç¸ÐµÄ²î±ÈºÍ×÷ÎªÆ«²î
  197           *             ÔÚ»·µºÊ±ÖÐ£ºÓÃÁ¿´¹Ö±µç¸ÐµÄ²î±ÈºÍ×÷ÎªÆ«²î
  198           *
  199           *            µç¸ÐÖµ¶ÔÓ¦±äÁ¿
  200           *
  201           *   g_ValueOfAD[0]£º1500             g_ValueOfAD[1]£º1500
  202           *      (Ë®Æ½×óµç¸Ð)                        £¨Ë®Æ½ÓÒµç¸Ð£©
  203           *          g_ValueOfAD[2]£º3400      g_ValueOfAD[3]£º3400
  204           *         £¨´¹Ö±×óµç¸Ð£©               £¨´¹Ö±ÓÒµç¸Ð£©
  205           * date *        2020
  206           *************************************************************************/
  207          
  208          void DirectionControl(void)
  209          {
  210   1      
  211   1          static float g_fDirectionErrorTemp[2][5];
  212   1      
  213   1      //    Read_ADC();
  214   1          InductorNormal();
  215   1      
  216   1      
  217   1      //    all = (all < 10 ? 10 : all); //ËÄ¸öµç¸ÐÖµÏÞ·ù
  218   1      //    al = (al < 10 ? 10 : al);
  219   1      //    mid = (mid < 10 ? 10 : mid);
  220   1      //    ar = (ar < 10 ? 10 : ar);
  221   1      //    arr = (arr < 10 ? 10 : arr);
  222   1      //  g_ValueOfAD[5] = (g_ValueOfAD[5] < 10? 10:g_ValueOfAD[5]);
  223   1      //  g_ValueOfAD[6] = (g_ValueOfAD[6] < 10? 10:g_ValueOfAD[6]);
  224   1      //  g_ValueOfAD[7] = (g_ValueOfAD[7] < 10? 10:g_ValueOfAD[7]);
  225   1      //  g_ValueOfAD[8] = (g_ValueOfAD[8] < 10? 10:g_ValueOfAD[8]);
  226   1      
  227   1      
  228   1      
  229   1      
  230   1          g_fDirectionError[0] = (float)(sqrt(g_ValueOfAD[2]) - sqrt(g_ValueOfAD[3])) * 100 / (sqrt(g_ValueOfAD
             -[3]) + sqrt(g_ValueOfAD[2])); //Ë®Æ½µç¸ÐµÄ²î±ÈºÍ×÷ÎªÆ«²îÎªÆ«²î
  231   1          g_fDirectionError[1] = (float)(sqrt(g_ValueOfAD[5]) - sqrt(g_ValueOfAD[1])) * 100 / (sqrt(g_ValueOfAD
             -[5]) + sqrt(g_ValueOfAD[1]));
  232   1          g_fDirectionError[2] = (float)(0.8*(sqrt(g_ValueOfAD[2]) - sqrt(g_ValueOfAD[3]))+
  233   1                                        0.4*(sqrt(g_ValueOfAD[4]) - sqrt(g_ValueOfAD[1]))) * 100 / 
  234   1                                                              (0.8*(sqrt(g_ValueOfAD[3]) + sqrt(g_ValueOfAD[2]))+0
             -.4*abs(sqrt(g_ValueOfAD[4]) - sqrt(g_ValueOfAD[1])));
  235   1          g_fDirectionErrorTemp[0][4] = g_fDirectionErrorTemp[0][3];
  236   1          g_fDirectionErrorTemp[0][3] = g_fDirectionErrorTemp[0][2];
  237   1          g_fDirectionErrorTemp[0][2] = g_fDirectionErrorTemp[0][1];
  238   1          g_fDirectionErrorTemp[0][1] = g_fDirectionErrorTemp[0][0];
  239   1          g_fDirectionErrorTemp[0][0] = g_fDirectionError[0];
  240   1          g_fDirectionError_dot[0] = 5 * (g_fDirectionErrorTemp[0][0] - g_fDirectionErrorTemp[0][3]); //Ë®Æ½µç¸
             -ÐµÄÆ«²îÎ¢·Ö
  241   1          
  242   1      if((abs(g_ValueOfAD[2]-g_ValueOfAD[3])<15&&g_ValueOfAD[2]>30&&g_ValueOfAD[3]>30)||(abs(g_ValueOfAD[4]-g_V
             -alueOfAD[1])<=9&&g_ValueOfAD[4]>28&&g_ValueOfAD[1]>28))
  243   1      {
  244   2         zhidaoflag++;
  245   2      }
  246   1      else
  247   1      {
C251 COMPILER V5.60.0,  Direction                                                          26/06/23  11:07:02  PAGE 5   

  248   2         zhidaoflag = 0;
  249   2      
  250   2      }
  251   1      
  252   1      
  253   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =    ------     ------
  ecode size           =      2176     ------
  data size            =        18     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =       324        162
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       161     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
